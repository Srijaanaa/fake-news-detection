<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard</title>
<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Custom CSS -->
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body class="bg-light">

{% include 'base.html' %}

<div class="container my-5 pt-4"> 
    <div class="row justify-content-center">
        <div class="col-lg-12">
            <div class="card shadow-lg border-0 rounded-4">
                <div class="card-body p-5">

                    <h1 class="display-5 fw-bold text-primary mb-5 border-bottom pb-3">Administrator Dashboard</h1>

                    <!-- Flash messages -->
                    {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                        {% endfor %}
                    {% endif %}
                    {% endwith %}

                    <!-- Top Statistics Cards & Retraining Card -->
                    <div class="row g-4 mb-5">
                        
                        <!-- Total Registered Users Card -->
                        <div class="col-lg-4 col-md-6">
                            <div class="card border-primary border-start border-4 shadow-sm h-100">
                                <div class="card-body p-4">
                                    <p class="text-secondary fw-semibold mb-1">Total Registered Users</p>
                                    <p class="display-4 fw-bolder text-primary">{{ total_users }}</p>
                                </div>
                            </div>
                        </div>

                        <!-- Model Management (Retraining Card with Progress) -->
                        <div class="col-lg-8 col-md-6">
                            <div class="card border-danger border-start border-4 shadow-sm h-100">
                                <div class="card-body p-4">
                                    <p class="h5 text-danger fw-bold mb-3">Model Management</p>
                                    <p class="text-muted small mb-4">
                                        Click the button below to retrain the model with the latest datasets. This process is synchronous and may take a moment.
                                    </p>

                                    <!-- Progress Bar Container -->
                                    <div id="training-progress-container" class="mb-3" style="display:none;">
                                        <div class="progress" style="height: 25px;">
                                            <div id="training-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-danger" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                                <span id="training-progress-text">Waiting...</span>
                                            </div>
                                        </div>
                                    </div>

                                    <form id="retrain-form" action="{{ url_for('admin_retrain') }}" method="POST">
                                        <button type="submit" id="retrain-button" class="btn btn-danger w-100 fw-bold py-2 shadow-sm">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-arrow-clockwise me-2" viewBox="0 0 16 16">
                                                <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .914-.233A6 6 0 1 1 8 2z"/>
                                                <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384l-2.36 1.966a.25.25 0 0 1-.41-.192z"/>
                                            </svg>
                                            Trigger Model Retraining
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- User Prediction Statistics & Management Table -->
                    <h2 class="h3 fw-bold text-dark mb-4 border-bottom pb-2">User Management & Metrics</h2>

                    {% if user_stats %}
                    <div class="table-responsive rounded shadow-sm">
                        <table class="table table-striped table-hover table-bordered mb-0">
                            <thead class="table-primary">
                                <tr>
                                    <th scope="col" class="py-3 text-uppercase small">User ID</th>
                                    <th scope="col" class="py-3 text-uppercase small">Username</th>
                                    <th scope="col" class="py-3 text-uppercase small">Role</th>
                                    <th scope="col" class="py-3 text-uppercase small">Total Predictions</th>
                                    <th scope="col" class="py-3 text-uppercase small">Avg. Confidence</th>
                                    <th scope="col" class="py-3 text-uppercase small text-center" style="width: 250px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user_id, stats in user_stats.items() %}
                                <tr>
                                    <td class="fw-bold text-muted">{{ user_id }}</td>
                                    <td>{{ stats.username }}</td>
                                    <td>
                                        <form method="POST" action="{{ url_for('admin_update_role', user_id=user_id) }}" class="d-flex">
                                            <select name="new_role" class="form-select form-select-sm me-2">
                                                <option value="user" {% if stats.role == 'user' %} selected {% endif %}>User</option>
                                                <option value="admin" {% if stats.role == 'admin' %} selected {% endif %}>Admin</option>
                                            </select>
                                            <button type="submit" class="btn btn-sm btn-primary">Save</button>
                                        </form>
                                    </td>
                                    <td>{{ stats.total_predictions }}</td>
                                    <td class="fw-bold text-success">{{ stats.avg_confidence }}</td>
                                    <td class="text-center">
                                        <!-- Delete User History Button -->
                                        <form method="POST" action="{{ url_for('admin_delete_history', user_id=user_id) }}" style="display:inline-block;">
                                            <button type="submit" class="btn btn-sm btn-warning me-2" 
                                                    onclick="return confirm('Are you sure you want to delete ALL prediction history for {{ stats.username }}? This action is irreversible.')">
                                                <small>Del History</small>
                                            </button>
                                        </form>
                                        
                                        <!-- Delete User Account Button -->
                                        <form method="POST" action="{{ url_for('admin_delete_user', user_id=user_id) }}" style="display:inline-block;">
                                            <button type="submit" class="btn btn-sm btn-danger" 
                                                    {% if user_id == session.get('user_id') %} disabled title="Cannot delete your own active account" {% endif %}
                                                    onclick="return confirm('Are you ABSOLUTELY sure you want to delete the user {{ stats.username }} (ID: {{ user_id }}) and all their data? This action is irreversible.')">
                                                <small>Del User</small>
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        No user prediction history available yet.
                    </div>
                    {% endif %}

                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- JavaScript for Progress Bar Polling -->
<script>
    const progressBar = document.getElementById('training-progress-bar');
    const progressText = document.getElementById('training-progress-text');
    const progressContainer = document.getElementById('training-progress-container');
    const retrainButton = document.getElementById('retrain-button');
    const retrainForm = document.getElementById('retrain-form');
    let pollingInterval = null;

    // NOTE: The initial_status variable is passed from the Python backend via Jinja templating.
    const initialStatus = JSON.parse('{{ initial_status | tojson | safe }}');

    // Function to update the progress bar UI
    function updateProgress(progress, message, isRunning) {
        progress = Math.min(100, Math.max(0, progress)); // Keep progress between 0 and 100

        progressBar.style.width = progress + '%';
        progressBar.setAttribute('aria-valuenow', progress);
        progressText.textContent = `${progress}% - ${message}`;
        
        if (isRunning) {
            progressContainer.style.display = 'block';
            retrainButton.disabled = true;
            retrainButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Training...';
            // Ensure bar is striped/animated while running
            progressBar.classList.add('progress-bar-striped', 'progress-bar-animated');
        } else {
            retrainButton.disabled = false;
            retrainButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-arrow-clockwise me-2" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .914-.233A6 6 0 1 1 8 2z"/><path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384l-2.36 1.966a.25.25 0 0 1-.41-.192z"/></svg>Trigger Model Retraining';
            progressBar.classList.remove('progress-bar-striped', 'progress-bar-animated');

            // Hide the bar if training is 100% complete and not currently running
            if (progress >= 100) {
                setTimeout(() => { progressContainer.style.display = 'none'; }, 2000); 
            }
        }
    }

    // Function to poll the server for training status
    function pollStatus() {
        fetch('{{ url_for("api_training_progress") }}')
            .then(response => {
                if (response.status === 401) throw new Error('Unauthorized');
                return response.json();
            })
            .then(data => {
                updateProgress(data.progress, data.message, data.is_running);
                
                if (!data.is_running && pollingInterval) {
                    // Training finished, stop polling
                    clearInterval(pollingInterval);
                    pollingInterval = null;
                    
                    // Reload the page to display final metrics and flash messages (500ms delay)
                    setTimeout(() => { window.location.reload(); }, 500);
                }
            })
            .catch(error => {
                console.error('Error polling training status:', error);
                if (pollingInterval) {
                    clearInterval(pollingInterval);
                    pollingInterval = null;
                }
                // Only show an error message if the training was actively running
                if (retrainButton.disabled) { 
                    updateProgress(0, 'Server connection lost. Please reload.', false);
                }
            });
    }

    // Handle the retraining form submission
    retrainForm.addEventListener('submit', function(event) {
        event.preventDefault(); 
        
        // Immediately update the status to starting
        updateProgress(5, 'Starting training...', true);

        // Start the polling cycle
        if (!pollingInterval) {
            pollingInterval = setInterval(pollStatus, 500); // Poll every 500ms
        }
        
        // Submit the form request in the background
        fetch(retrainForm.action, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                // This handles the immediate status response from the synchronous Flask route.
                // Polling will handle the subsequent updates.
                updateProgress(data.progress, data.message, data.is_running);
            })
            .catch(error => { 
                console.error('Retrain request failed:', error);
                clearInterval(pollingInterval);
                pollingInterval = null;
                updateProgress(0, 'Retrain request failed. Check server logs.', false);
            });
    });

    // Initial check on page load: If training was running, resume polling
    window.onload = function() {
        updateProgress(initialStatus.progress, initialStatus.message, initialStatus.is_running);
        if (initialStatus.is_running) {
            // Resume polling if the server indicated training was still running
            if (!pollingInterval) {
                 pollingInterval = setInterval(pollStatus, 500);
            }
        }
    };
</script>

</body>
</html>